# Реєстрація особистого Telegram-акаунта для одноразового промо (Railway)

Покрокова інструкція, щоб **максимально автоматизовано** підключити відправку одноразових промо-повідомлень від вашого особистого акаунта на **Railway**.

---

## Що це дає

При додаванні оголошення в **Viber Rides**:

- Якщо автор **вже в боті** — йому летить сповіщення **від бота** (як і раніше).
- Якщо автора **немає в боті**, але є в базі (Person) і ви ще **ні разу не слали** йому промо — один раз відправляється повідомлення **від вашого особистого акаунта** (з текстом оголошення + інструкція підписатися на бота). Далі для цього номера ставиться мітка, щоб не спамити.

Щоб це працювало на Railway, потрібно **один раз** отримати API-ключі, авторизувати свій акаунт локально, залити сесію в змінну — далі усе працює автоматично при кожному деплої.

---

## Крок 1: Отримати API ID та API Hash (≈2 хв)

1. Відкрийте **https://my.telegram.org/apps** і увійдіть за **номером телефону** (той, з якого будете слати промо).
2. Якщо просить — створіть застосунок: назва (наприклад `Malyn Promo`), платформа (наприклад Desktop). Натисніть **Create application**.
3. Скопіюйте і збережіть:
   - **App api_id** (число, наприклад `12345678`);
   - **App api_hash** (рядок, наприклад `a1b2c3d4e5f6...`).

Ці значення потрібні для кроку 4 (змінні на Railway).

**Ваші значення (Malin Routes) — можна копіювати в Railway і в команди нижче:**

| Змінна | Значення |
|--------|----------|
| `TELEGRAM_API_ID` | `35082143` |
| `TELEGRAM_API_HASH` | `8095eb80857cacd09c29c7891d1bf4e5` |

---

## Крок 2: Авторизувати свій акаунт локально — створити файл сесії (≈3 хв)

Це робиться **один раз на вашому комп’ютері** (Mac/Linux/Windows з Python 3).

### 2.1 Встановити залежності та запустити авторизацію

У терміналі в корені проєкту:

```bash
cd backend/telegram-user
pip install -r requirements.txt
export TELEGRAM_API_ID="35082143"
export TELEGRAM_API_HASH="8095eb80857cacd09c29c7891d1bf4e5"
python3 auth_session.py
```

### 2.2 Що запитає скрипт

1. **Номер телефону** — у міжнародному форматі, наприклад `+380671234567`.
2. **Код з Telegram** — код підтвердження, який прийде в додаток Telegram.
3. **Пароль 2FA** — якщо у вас увімкнена двофакторна авторизація (інакше просто Enter).

Після успіху з’явиться рядок на кшталт:  
`Успішно авторизовано: Ваше Ім'я (@username)`  
і в папці `backend/telegram-user/` з’являться файли:

- `session_telegram_user.session`
- (іноді) `session_telegram_user.session-journal`

**Важливо:** ці файли дають доступ до вашого Telegram — не публікуйте їх і не комітьте в git.

---

## Крок 3: Закодувати сесію в Base64 для Railway

У терміналі (у папці, де лежить файл сесії):

**macOS:**
```bash
cd backend/telegram-user
base64 -i session_telegram_user.session | pbcopy
```

**Linux (GNU base64):**
```bash
cd backend/telegram-user
base64 -w0 session_telegram_user.session | xclip -selection clipboard
```
(Якщо немає `xclip`: `base64 -w0 session_telegram_user.session` — виведеться в консоль, скопіюйте вручну.)

**Windows (PowerShell):**
```powershell
cd backend\telegram-user
[Convert]::ToBase64String([IO.File]::ReadAllBytes("session_telegram_user.session")) | Set-Clipboard
```

У буфері обміну тепер один довгий рядок (Base64). Він потрібен для наступного кроку.

---

## Крок 4: Додати змінні середовища в Railway

1. Відкрийте **Railway Dashboard** → ваш проєкт → сервіс **backend**.
2. Перейдіть у **Variables** (або **Settings** → **Environment**).
3. Додайте або перевірте такі змінні:

| Змінна | Значення | Обов’язково |
|--------|----------|-------------|
| `TELEGRAM_API_ID` | `35082143` | Так |
| `TELEGRAM_API_HASH` | `8095eb80857cacd09c29c7891d1bf4e5` | Так |
| `TELEGRAM_USER_SESSION_BASE64` | Вставте з буфера обміну (Base64 з кроку 3) | Так |

Інших змінних для цієї фічі **вказувати не потрібно**: шлях до сесії на сервері backend **створює сам** при старті з `TELEGRAM_USER_SESSION_BASE64`.

Переконайтеся, що вже налаштовані звичайні Telegram-змінні для бота:
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_ADMIN_CHAT_ID` (за потреби)

Збережіть змінні. Railway автоматично перезадеплоїть backend.

---

## Крок 5: Перевірити деплой

1. Після деплою відкрийте **Deploy Logs** (логи запуску) backend.
2. Має з’явитися рядок:  
   `[KYIV-MALYN-BACKEND] Telegram user session restored from TELEGRAM_USER_SESSION_BASE64`  
   — це означає, що сесія змінної успішно розпакована і готова до використання.

Якщо цього рядка немає — перевірте, що всі три змінні (`TELEGRAM_API_ID`, `TELEGRAM_API_HASH`, `TELEGRAM_USER_SESSION_BASE64`) задані і без зайвих пробілів.

---

## Крок 6: Міграція бази (якщо ще не робили)

Поле `telegramPromoSentAt` у таблиці `Person` має вже бути (міграція в проєкті). Якщо деплой на Railway сам виконує міграції (`prisma migrate deploy` у `npm start`), нічого робити не потрібно. Якщо міграції запускаєте окремо — виконайте їх один раз для цього backend.

---

## Як перевірити, що все працює

1. Додайте тестове **Viber-оголошення** з номером людини, яка **не** в боті і для якої ще не слали промо.
2. У **Deploy Logs** (або Runtime Logs) backend має з’явитися щось на кшталт:  
   `✅ Telegram: автору Viber оголошення #N надіслано одноразове промо від вашого акаунта, Person.telegramPromoSentAt оновлено`
3. У базі в записі `Person` для цього номера має заповнитися поле `telegramPromoSentAt`.
4. При наступному оголошенні з того ж номера повторне промо **не** відправляється.

---

## Що відбувається автоматично на Railway

- При **кожному деплої** backend при старті перевіряє наявність `TELEGRAM_USER_SESSION_BASE64`. Якщо змінна задана — розкодовує її і **записує файл сесії** у `telegram-user/session_telegram_user.session` і виставляє `TELEGRAM_USER_SESSION_PATH`. Ручне завантаження файлів на сервер **не потрібне**.
- У збірці на Railway (nixpacks) вже є **Python 3** і встановлений **Telethon** з `telegram-user/requirements.txt`, тому скрипт `send_message.py` викликається без додаткових кроків.

---

## Якщо змінили пароль Telegram або вийшли з акаунта

Потрібно **повторити кроки 2 і 3**: знову запустити `auth_session.py` локально, отримати новий `session_telegram_user.session`, закодувати його в Base64 і **оновити** змінну `TELEGRAM_USER_SESSION_BASE64` в Railway. Після наступного деплою буде використовуватися нова сесія.

---

## Короткий чеклист

- [ ] Отримано **API ID** та **API Hash** на https://my.telegram.org/apps
- [ ] Локально виконано `python3 auth_session.py` і отримано файл `session_telegram_user.session`
- [ ] Файл сесії закодовано в Base64 і значення вставлено в змінну **TELEGRAM_USER_SESSION_BASE64** на Railway
- [ ] У Railway додано **TELEGRAM_API_ID** та **TELEGRAM_API_HASH**
- [ ] Після деплою в логах є рядок про відновлення сесії з Base64
- [ ] Тестове Viber-оголошення для номера «не в боті» призводить до логу про відправку одноразового промо та оновлення `telegramPromoSentAt`

Після виконання цих кроків реєстрація особистого акаунта для одноразового промо на Railway завершена, і подальша робота повністю автоматична.

---

## Що зробити на сервері (Railway), коли ви все закомітите

Після `git push` (деплой на Railway вже йде автоматично). Вам потрібно лише **додати змінні** і **один раз авторизувати акаунт**:

1. **Закомітьте й запуште** зміни (backend з telegram-user, nixpacks.toml тощо). Дочекайтеся успішного деплою.

2. **Локально** (на своєму комп’ютері):
   - `cd backend/telegram-user`
   - `pip install -r requirements.txt`
   - `export TELEGRAM_API_ID="35082143"`
   - `export TELEGRAM_API_HASH="8095eb80857cacd09c29c7891d1bf4e5"`
   - `python3 auth_session.py` → ввести номер телефону, код з Telegram, 2FA (якщо є).
   - Після успіху: закодувати сесію в Base64 (команди в Кроці 3 вище) і скопіювати результат.

3. **У Railway:** проєкт → сервіс **backend** → **Variables**. Додати:
   - `TELEGRAM_API_ID` = `35082143`
   - `TELEGRAM_API_HASH` = `8095eb80857cacd09c29c7891d1bf4e5`
   - `TELEGRAM_USER_SESSION_BASE64` = (вставити скопійований Base64 з п. 2)

4. Зберегти змінні. Railway перезадеплоїть backend. У **Deploy Logs** має з’явитися:  
   `[KYIV-MALYN-BACKEND] Telegram user session restored from TELEGRAM_USER_SESSION_BASE64`.

Готово. Далі одноразове промо для нових авторів Viber-оголошень (без бота) працюватиме автоматично.
